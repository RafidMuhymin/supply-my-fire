---
import { Icon } from "astro-icon/components";

import Button from "@/components/Button.astro";

const interestedInOptions = [
  "Media Wall Installations",
  "Electric Fireplaces",
  "Gas Fireplaces",
  "Wood Burning Stoves",
];

const bestTimeToContactOptions = [
  "Morning (9am - 12pm)",
  "Afternoon (12pm - 4pm)",
  "Evening (4pm - 8pm)",
];

const howDidYouHearAboutUsOptions = [
  "Google Search",
  "Social Media",
  "Word of Mouth",
  "Advertisement",
  "Other",
];
---

<section>
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
    <div>
      <div class="grid max-lg:text-center gap-3">
        <h2>Visit Our Cardiff <em>Showroom</em></h2>

        <p class="text-body-variant-1 md:max-w-102 max-lg:mx-auto text-left">
          Fill out the form below and we'll get back to you within 24 hours
          during business days. The more details you provide, the better we can
          help.
        </p>
      </div>
    </div>

    <form
      action="https://api.web3forms.com/submit"
      method="POST"
      novalidate
      id="enquiry-form"
      class="grid gap-5 text-sm"
    >
      <!-- Web3Forms Access Key -->
      <input
        type="hidden"
        name="access_key"
        value={import.meta.env.PUBLIC_WEB3FORMS_ACCESS_KEY}
      />

      <!-- Custom Subject Line to identify this form -->
      <input type="hidden" name="subject" value="Enquiry Request" />

      <!-- Honeypot Spam Protection -->
      <input type="checkbox" name="botcheck" class="hidden" />

      <div class="grid grid-cols-2 gap-3.5">
        <div class="grid gap-1">
          <label for="full-name" class="font-semibold">
            Full name<sub class="text-red-500 text-2xl">*</sub>
          </label>

          <input
            type="text"
            class="input-variant-1"
            name="full-name"
            id="full-name"
            placeholder="John Smith"
            required
          />

          <p class="invalid-feedback text-red-500 mt-1 hidden">
            Please provide your full name
          </p>
        </div>

        <div class="grid gap-1">
          <label for="email-address" class="font-semibold">
            Email Address<sub class="text-red-500 text-2xl">*</sub>
          </label>

          <input
            type="email"
            class="input-variant-1"
            name="email-address"
            id="email-address"
            placeholder="your.email@example.com"
            required
          />

          <p class="invalid-feedback text-red-500 mt-1 hidden">
            Please provide your email address correctly
          </p>
        </div>
      </div>

      <div class="grid gap-1">
        <label for="phone-number" class="font-semibold">
          Phone Number<sub class="text-red-500 text-2xl">*</sub>
        </label>

        <input
          type="tel"
          class="input-variant-1"
          name="phone-number"
          id="phone-number"
          placeholder="Your Phone Number"
          required
        />

        <p class="invalid-feedback text-red-500 mt-1 hidden">
          Please provide your phone number correctly
        </p>
      </div>

      <div class="grid gap-1">
        <label for="postcode" class="font-semibold">
          Postcode<sub class="text-red-500 text-2xl">*</sub>
        </label>

        <input
          type="text"
          class="input-variant-1"
          name="postcode"
          id="postcode"
          placeholder="CF14 3LY"
          required
        />

        <p class="invalid-feedback text-red-500 mt-1 hidden">
          Please provide your postcode correctly
        </p>
      </div>

      <div class="grid gap-1">
        <label for="interested-in" class="font-semibold">
          I'm Interested In<sub class="text-red-500 text-2xl">*</sub>
        </label>

        <select id="interested-in" name="interested-in" class="input-variant-1">
          {
            interestedInOptions.map((option) => (
              <option value={option}>{option}</option>
            ))
          }
        </select>
      </div>

      <div class="grid gap-1">
        <label for="preferred-contact-method" class="font-semibold">
          Preferred Contact Method<sub class="text-red-500 text-2xl">*</sub>
        </label>

        <div class="flex gap-5">
          <label class="flex gap-2 items-center">
            <input
              type="radio"
              class="accent-neutral-500"
              name="preferred-contact-method"
              value="phone"
              checked
            />

            <span>Phone</span>
          </label>

          <label class="flex gap-2 items-center">
            <input
              type="radio"
              class="accent-neutral-500"
              name="preferred-contact-method"
              value="email"
            />

            <span>Email</span>
          </label>

          <label class="flex gap-2 items-center">
            <input
              type="radio"
              class="accent-neutral-500"
              name="preferred-contact-method"
              value="whatsapp"
            />

            <span>WhatsApp</span>
          </label>
        </div>
      </div>

      <div class="grid gap-1">
        <label for="best-time-to-contact" class="font-semibold">
          Best Time to Contact<sub class="text-red-500 text-2xl">*</sub>
        </label>

        <select
          id="best-time-to-contact"
          name="best-time-to-contact"
          class="input-variant-1"
        >
          {
            bestTimeToContactOptions.map((time) => (
              <option value={time}>{time}</option>
            ))
          }
        </select>
      </div>

      <div class="grid gap-1">
        <label for="message" class="font-semibold">
          Message<sub class="text-red-500 text-2xl">*</sub>
        </label>

        <textarea
          form="enquiry-form"
          rows="4"
          class="input-variant-1 h-24.5 resize-none"
          name="message"
          id="message"
          placeholder="Tell us about your project, questions, or requirements. Include room dimensions if known, property type, and any specific ideas you have."
          required></textarea>

        <p class="invalid-feedback text-red-500 mt-1 hidden">
          Please provide your message
        </p>
      </div>

      <div class="grid gap-1">
        <label for="best-time-to-contact" class="font-semibold">
          How did you hear about us<sub class="text-red-500 text-2xl">*</sub>
        </label>

        <select
          id="how-did-you-hear-about-us"
          name="how-did-you-hear-about-us"
          class="input-variant-1"
        >
          {
            howDidYouHearAboutUsOptions.map((option) => (
              <option value={option}>{option}</option>
            ))
          }
        </select>
      </div>

      <div class="flex flex-wrap items-baseline gap-2.5">
        <input
          type="checkbox"
          class="accent-primary-500"
          name="consent"
          id="consent"
          required
        />

        <label for="consent" class="flex-1">
          I agree to Supply My Fire storing and processing my information to
          respond to my enquiry, in accordance with the Privacy Policy.
        </label>

        <p class="invalid-feedback text-red-500 mt-1 hidden w-full">
          You must agree before submitting
        </p>
      </div>

      <div class="mt-3">
        <Button
          type="submit"
          text="Send Enquiry"
          width="full"
          variant="primary"
        />

        <p id="enquiry-form-result" class="mt-3 font-medium"></p>
      </div>
    </form>
  </div>
</section>

<section
  id="enquiry-form-modal"
  class="hidden bg-black/50 top-0 left-0 fixed size-full items-center justify-center z-10"
>
  <div
    class="relative bg-white rounded-[10px] md:rounded-2xl lg:rounded-3xl px-10 md:px-15 lg:px-22.5 py-6 md:py-10 lg:py-12.5"
  >
    <button
      type="button"
      id="enquiry-form-close"
      aria-label="Close"
      class="size-3 md:size-4.5 absolute top-3 md:top-5.5 right-3 md:right-5.5"
    >
      <Icon id="enquiry-form-close" name="cross" class="size-full" />
    </button>

    <div class="grid gap-7.5 max-w-xl">
      <Icon name="thank-you" class="size-34 md:size-50 lg:size-72 mx-auto" />

      <div class="grid gap-2 text-center">
        <h2 id="enquiry-modal-title">Thank You!</h2>

        <p class="text-body-variant-1 text-neutral-500 leading-6">
          Thank You for your enquiry! Weâ€™ve received your message and will
          respond within 24 hours. If your enquiry is urgent, please call us on
          <strong>
            <a href="tel:02920309664" class="hover:underline">029 2030 9664</a>
          </strong>
        </p>
      </div>
    </div>
  </div>
</section>

<style lang="scss">
  @reference "@/styles/global.css";

  .was-validated {
    input,
    textarea,
    select {
      &:invalid {
        @apply outline-red-500 bg-white;

        & ~ .invalid-feedback {
          @apply block;
        }
      }
    }
  }
</style>

<script>
  const form = document.getElementById("enquiry-form") as HTMLFormElement,
    modal = document.getElementById("enquiry-form-modal"),
    result = document.getElementById("enquiry-form-result"),
    closeBtn = document.getElementById("enquiry-form-close");

  const openModal = () => {
    if (!modal) return;

    modal.classList.add("flex");
    modal.classList.remove("hidden");
    document.body.classList.add("overflow-hidden");

    closeBtn && closeBtn.focus();
  };

  const closeModal = () => {
    if (!modal) return;

    modal.classList.add("hidden");
    modal.classList.remove("flex");
    document.body.classList.remove("overflow-hidden");
  };

  form?.addEventListener("submit", function (e) {
    e.preventDefault();

    form.classList.add("was-validated");

    if (!form.checkValidity()) {
      const [invalidEl] = form.querySelectorAll<HTMLInputElement>(":invalid");

      invalidEl.focus();

      return;
    }

    const formData = new FormData(form),
      object = Object.fromEntries(formData),
      json = JSON.stringify(object);

    if (result) {
      result.style.display = "block";
      result.innerHTML = "Sending...";
      result.classList.remove("text-green-500", "text-red-500");
    }

    fetch("https://api.web3forms.com/submit", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Accept: "application/json",
      },
      body: json,
    })
      .then(async (response) => {
        let data = await response.json();

        if (response.status == 200) {
          if (result) result.style.display = "none";

          openModal();
        } else {
          console.log(response);

          if (result) {
            result.classList.add("text-red-500");
            result.innerHTML = data.message;
          }
        }
      })
      .catch((error) => {
        console.log(error);

        if (result) {
          result.classList.add("text-red-500");
          result.innerHTML = "Something went wrong!";
        }
      })
      .then(function () {
        form.reset();
        form.classList.remove("was-validated");

        setTimeout(() => {
          if (result) result.style.display = "none";
        }, 5000);
      });
  });

  closeBtn?.addEventListener("click", () => closeModal());

  modal?.addEventListener("click", (e) => {
    if (e.target === modal) {
      closeModal();
    }
  });

  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && modal && !modal.classList.contains("hidden")) {
      closeModal();
    }
  });
</script>
